<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>미래확언 — 하이브리드(A/B) | thisdive</title>

  <!-- 데모 단계용 CSP (배포 시 app.css/app.js 분리 + 'unsafe-inline' 제거 권장) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data:; 
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline';
    font-src 'self';
    connect-src 'self';
    frame-ancestors 'none';
    base-uri 'self';
    upgrade-insecure-requests
  ">
  <meta name="color-scheme" content="light" />
  <meta name="referrer" content="strict-origin-when-cross-origin">

  <style>
    :root{
      /* 지윤 무드 팔레트 */
      --bg:#f7f3ed;        /* 전체 배경 연베이지 */
      --card:#ffffff;      /* 카드 배경 */
      --fg:#2a3249;        /* 네이비 텍스트 */
      --muted:#6b7280;     /* 보조 텍스트 */
      --rose-50:#fbf2f0;   /* 매우 연한 로즈 */
      --rose-100:#f4e6e2;  /* 연 로즈 */
      --rose-300:#d7a8b5;  /* 중간 로즈 */
      --beige-200:#ece6df; /* 라인 */
      --beige-300:#e5ddd3; /* hover */
      --ok:#2a7a4b;        /* 확인 색 */
      --wrap:980px;
      --r-xl:22px; --r-md:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Pretendard", "Apple SD Gothic Neo", "Malgun Gothic", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* 헤더 */
    .header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--beige-200)}
    .header .inner{max-width:var(--wrap); margin:0 auto; padding:14px 22px; display:flex; align-items:center; justify-content:center}
    .title{font-weight:700}

    /* 레이아웃 */
    .wrap{display:grid; place-items:center; padding:22px}
    .card{width:100%; max-width:var(--wrap); background:var(--card); border:1px solid var(--beige-200); border-radius:var(--r-xl); box-shadow:0 8px 24px rgba(0,0,0,.04); overflow:hidden}
    .card-head{padding:0 22px; border-bottom:1px solid var(--beige-200)}

    /* 탭 */
    .tabs{display:flex; gap:8px; padding:10px 0}
    .tab{appearance:none; background:#fff; color:var(--fg); border:1px solid var(--beige-200); border-bottom:none; padding:10px 14px; border-top-left-radius:14px; border-top-right-radius:14px; cursor:pointer; font-weight:600}
    .tab[aria-selected="true"]{background:var(--rose-50); border-color:var(--rose-300)}

    .card-body{padding:18px 22px}
    .section + .section{margin-top:18px}

    /* 칩 영역 (A) */
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .chip{
      --chip-pad: 10px 14px;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      background:#fff; border:1px solid var(--beige-200); color:var(--fg);
      padding:var(--chip-pad); border-radius:999px; font-size:14px;
      transition:transform .06s ease, background-color .2s ease, border-color .2s ease;
    }
    .chip:hover{background:var(--beige-300)}
    .chip:active{transform:translateY(1px)}
    .chip input{appearance:none; width:14px; height:14px; border:1.5px solid var(--beige-200); border-radius:50%; display:inline-block; position:relative}
    .chip[aria-checked="true"] input{border-color:var(--rose-300)}
    .chip[aria-checked="true"] input::after{content:""; position:absolute; inset:3px; background:var(--rose-300); border-radius:50%}

    /* 공통 폼 */
    .fields{display:grid; gap:12px; margin-top:14px}
    .field{display:none}
    .field.show{display:block}
    .label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    .input{
      width:100%; background:#fff; border:1px solid var(--beige-200); border-radius:12px; padding:12px 14px; font-size:15px; color:var(--fg);
      outline:none; transition:border-color .2s ease, box-shadow .2s ease; resize:vertical; min-height:44px
    }
    .input:focus{border-color:var(--rose-300); box-shadow:0 0 0 3px rgba(215,168,181,.22)}
    .template{font-size:13px; color:var(--muted); margin-top:6px}

    /* 시각화 체크 */
    .visualize{display:flex; align-items:center; gap:10px; padding:14px; background:var(--rose-100); border:1px solid var(--beige-200); border-radius:var(--r-md); margin-top:12px}
    .visualize input{width:16px; height:16px}

    /* B 전용 필드 */
    .grid{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:720px){ .grid{grid-template-columns:repeat(3,1fr)} }
    .small{font-size:13px; color:var(--muted)}
    .preview{padding:14px; background:var(--rose-50); border:1px solid var(--beige-200); border-radius:var(--r-md); line-height:1.65}
    .preview strong{background:linear-gradient(transparent 58%, var(--rose-100) 0)}

    /* 푸터 */
    .card-foot{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 22px; border-top:1px solid var(--beige-200); background:#fff}
    .btn{appearance:none; border:1px solid var(--beige-200); background:var(--fg); color:#fff; padding:12px 18px; border-radius:999px; font-weight:600; font-size:15px; cursor:pointer; transition:transform .06s ease, opacity .2s ease}
    .btn:hover{opacity:.95}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.45; cursor:not-allowed}
    .btn-secondary{background:#fff; color:var(--fg)}

    /* 토스트 */
    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#111; color:#fff; padding:12px 16px; border-radius:999px; font-size:14px; box-shadow:0 8px 24px rgba(0,0,0,.18); opacity:0; pointer-events:none; transition:opacity .25s ease}
    .toast.show{opacity:1}

    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <a class="sr-only" href="#main">본문 바로가기</a>
  <header class="header">
    <div class="inner"><div class="title">미래확언 — 하이브리드(A/B)</div></div>
  </header>

  <main id="main" class="wrap">
    <article class="card" aria-labelledby="h1">
      <div class="card-head">
        <div class="tabs" role="tablist" aria-label="확언 방식 선택">
          <button id="tab-a" class="tab" role="tab" aria-selected="true" aria-controls="panel-a">간단 확언(A)</button>
          <button id="tab-b" class="tab" role="tab" aria-selected="false" aria-controls="panel-b">하루 시나리오(B)</button>
        </div>
      </div>

      <!-- A 패널 -->
      <section id="panel-a" class="card-body" role="tabpanel" aria-labelledby="tab-a">
        <header>
          <h1 id="h1" style="margin:0 0 6px">나는 지금 ____을 가지고 있다</h1>
          <div class="small">필요한 카테고리만 선택해 한 줄 확언으로 적어 보세요.</div>
        </header>

        <section class="section" aria-labelledby="sec-cat-a">
          <h2 id="sec-cat-a" class="sr-only">카테고리 선택</h2>
          <div class="chips" role="group" aria-label="카테고리(A)">
            <button class="chip" data-key="health" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>건강</span>
            </button>
            <button class="chip" data-key="wealth" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>부</span>
            </button>
            <button class="chip" data-key="relationship" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>관계</span>
            </button>
          </div>
        </section>

        <section class="section fields" aria-labelledby="sec-fields-a">
          <h2 id="sec-fields-a" class="sr-only">확언 입력</h2>
          <div class="field" data-key="health">
            <label class="label" for="aff-health">건강 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-health" class="input" rows="2" placeholder="예) 규칙적인 수면 리듬과 아침의 맑은 집중력"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>
          <div class="field" data-key="wealth">
            <label class="label" for="aff-wealth">부 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-wealth" class="input" rows="2" placeholder="예) 생활이 넉넉해지는 현금흐름과 안정적인 비상금"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>
          <div class="field" data-key="relationship">
            <label class="label" for="aff-relationship">관계 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-relationship" class="input" rows="2" placeholder="예) 서로의 시간을 존중하는 평온한 대화와 가벼운 웃음"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>
        </section>

        <section class="section" aria-labelledby="sec-visual-a">
          <h2 id="sec-visual-a" class="sr-only">시각화 체크(A)</h2>
          <label class="visualize">
            <input type="checkbox" id="visualized-a" />
            <div>
              <div><strong>눈을 감고 그 장면을 10초간 떠올려 보았어요</strong></div>
              <small>호흡 3번 + 몸의 감각까지 느껴보기</small>
            </div>
          </label>
        </section>
      </section>

      <!-- B 패널 -->
      <section id="panel-b" class="card-body" role="tabpanel" aria-labelledby="tab-b" hidden>
        <header>
          <h2 style="margin:0 0 6px">“나는 ___년 ___월 ___일, ___에서 ___와 함께 ___을 하고 있다.”</h2>
          <div class="small">짧고 구체적으로 적고, 장면을 10초간 떠올려 보세요.</div>
        </header>

        <section class="section" aria-labelledby="sec-basic-b">
          <h3 id="sec-basic-b" class="sr-only">기본 정보(B)</h3>
          <div class="grid">
            <div class="field"><label class="label" for="year">연도</label><input id="year" class="input" type="number" inputmode="numeric" placeholder="예) 2026" min="2024" max="2100" /></div>
            <div class="field"><label class="label" for="month">월</label><input id="month" class="input" type="number" inputmode="numeric" placeholder="예) 7" min="1" max="12" /></div>
            <div class="field"><label class="label" for="day">일</label><input id="day" class="input" type="number" inputmode="numeric" placeholder="예) 15" min="1" max="31" /></div>
            <div class="field"><label class="label" for="place">어디서</label><input id="place" class="input" type="text" placeholder="예) 성수동의 작업실에서" /></div>
            <div class="field"><label class="label" for="with">누구와</label><input id="with" class="input" type="text" placeholder="예) 좋아하는 동료와 함께" /></div>
            <div class="field"><label class="label" for="doing">무엇을</label><input id="doing" class="input" type="text" placeholder="예) 즐겁게 작업을 하고 있다" /></div>
          </div>
          <div class="small" style="margin-top:6px">예시: 나는 <strong>내년 여름(2026.7)</strong>, <strong>성수동의 작업실에서</strong> <strong>좋아하는 동료와 함께</strong> <strong>즐겁게 작업하고 있다</strong>.</div>
        </section>

        <section class="section" aria-labelledby="sec-preview-b">
          <h3 id="sec-preview-b" class="sr-only">미리보기(B)</h3>
          <div class="preview" id="preview">나는 <strong>____년 ____월 ____일</strong>, <strong>____</strong>에서 <strong>____</strong>와 함께 <strong>____</strong>을 하고 있다.</div>
        </section>

        <section class="section" aria-labelledby="sec-sense-b">
          <h3 id="sec-sense-b" class="sr-only">감각 디테일(B)</h3>
          <div class="grid">
            <div class="field"><label class="label" for="see">보이는 것(시각)</label><input id="see" class="input" type="text" placeholder="예) 오후 햇살, 페퍼민트 초록, 정리된 책상" /></div>
            <div class="field"><label class="label" for="hear">들리는 것(청각)</label><input id="hear" class="input" type="text" placeholder="예) 잔잔한 재즈, 키보드 타이핑 소리" /></div>
            <div class="field"><label class="label" for="feel">느껴지는 것(촉/후/미각)</label><input id="feel" class="input" type="text" placeholder="예) 손끝의 따뜻함, 은은한 커피 향" /></div>
          </div>
        </section>

        <section class="section" aria-labelledby="sec-visual-b">
          <h3 id="sec-visual-b" class="sr-only">시각화 체크(B)</h3>
          <label class="visualize">
            <input type="checkbox" id="visualized-b" />
            <div>
              <div><strong>눈을 감고 10초간 그 장면을 떠올려 보았어요</strong></div>
              <small>호흡 3번 + 몸의 감각까지 느껴보기</small>
            </div>
          </label>
        </section>
      </section>

      <div class="card-foot">
        <div class="small" id="hint">확언 방식을 선택해 내용을 작성하세요.</div>
        <div style="display:flex; gap:10px">
          <button class="btn btn-secondary" id="btn-clear" type="button">초기화</button>
          <button class="btn" id="btn-next" type="button" disabled>다음 → 목표설정</button>
        </div>
      </div>
    </article>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">저장되었습니다</div>

  <script>
    const KEY = 'thisdive_affirmation_hybrid_v1';

    // 탭
    const tabA = document.getElementById('tab-a');
    const tabB = document.getElementById('tab-b');
    const panelA = document.getElementById('panel-a');
    const panelB = document.getElementById('panel-b');

    // A-요소
    const chips = Array.from(document.querySelectorAll('.chip'));
    const fieldsA = Array.from(document.querySelectorAll('#panel-a .field'));
    const affHealth = document.getElementById('aff-health');
    const affWealth = document.getElementById('aff-wealth');
    const affRel = document.getElementById('aff-relationship');
    const visualizedA = document.getElementById('visualized-a');

    // B-요소
    const yearEl = document.getElementById('year');
    const monthEl = document.getElementById('month');
    const dayEl = document.getElementById('day');
    const placeEl = document.getElementById('place');
    const withEl = document.getElementById('with');
    const doingEl = document.getElementById('doing');
    const seeEl = document.getElementById('see');
    const hearEl = document.getElementById('hear');
    const feelEl = document.getElementById('feel');
    const preview = document.getElementById('preview');
    const visualizedB = document.getElementById('visualized-b');

    // 공통
    const nextBtn = document.getElementById('btn-next');
    const clearBtn = document.getElementById('btn-clear');
    const hint = document.getElementById('hint');
    const toast = document.getElementById('toast');

    // 상태
    let state = {
      mode: 'A',
      A: {
        selected: [], // ['health','wealth','relationship']
        values: { health:'', wealth:'', relationship:'' },
        visualized: false
      },
      B: {
        year:'', month:'', day:'', place:'', with:'', doing:'',
        see:'', hear:'', feel:'', visualized:false
      }
    };

    function flashToast(msg){
      toast.textContent = msg; toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    function save(showToast=false){
      try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
      if(showToast) flashToast('저장되었습니다');
    }

    function switchTab(mode){
      state.mode = mode;
      const aOn = mode==='A';
      tabA.setAttribute('aria-selected', String(aOn));
      tabB.setAttribute('aria-selected', String(!aOn));
      panelA.hidden = !aOn; panelB.hidden = aOn;
      render(); save(false);
    }

    function render(){
      // A-칩 & 필드 표시
      chips.forEach(chip=>{
        const key = chip.dataset.key;
        const on = state.A.selected.includes(key);
        chip.setAttribute('aria-checked', String(on));
        const field = document.querySelector(`#panel-a .field[data-key="${key}"]`);
        if(field) field.classList.toggle('show', on);
      });

      // A-값 반영
      if(affHealth) affHealth.value = state.A.values.health || '';
      if(affWealth) affWealth.value = state.A.values.wealth || '';
      if(affRel) affRel.value = state.A.values.relationship || '';
      if(visualizedA) visualizedA.checked = !!state.A.visualized;

      // B-미리보기
      const y = (state.B.year||'').trim() || '____';
      const m = (state.B.month||'').trim() || '__';
      const d = (state.B.day||'').trim() || '__';
      const plc = (state.B.place||'').trim() || '____';
      const w = (state.B.with||'').trim() || '____';
      const act = (state.B.doing||'').trim() || '____';
      preview.innerHTML = `나는 <strong>${y}년 ${m}월 ${d}일</strong>, <strong>${plc}</strong>에서 <strong>${w}</strong>와 함께 <strong>${act}</strong>을 하고 있다.`;
      if(visualizedB) visualizedB.checked = !!state.B.visualized;

      // 버튼 활성화 규칙
      let ok = false;
      if(state.mode==='A'){
        const anyText = state.A.selected.some(k => (state.A.values[k]||'').trim().length>0);
        ok = state.A.selected.length>0 && anyText;
        hint.textContent = ok ? '좋아요. 이제 목표설정으로 넘어갈 수 있어요.' : '카테고리를 선택하고 한 줄 확언을 적어주세요.';
      } else {
        const need = ['year','month','day','place','with','doing'];
        ok = need.every(k => (state.B[k]||'').trim().length>0);
        hint.textContent = ok ? '좋아요. 이제 목표설정으로 넘어갈 수 있어요.' : '연/월/일·장소·누구·무엇을 채워주세요.';
      }
      nextBtn.disabled = !ok;
    }

    // 이벤트 바인딩
    tabA.addEventListener('click', ()=> switchTab('A'));
    tabB.addEventListener('click', ()=> switchTab('B'));

    // 칩 토글
    chips.forEach(chip => {
      chip.addEventListener('click', () => {
        const key = chip.dataset.key;
        const i = state.A.selected.indexOf(key);
        if(i>=0) state.A.selected.splice(i,1); else state.A.selected.push(key);
        save(false); render();
      });
    });

    // A 입력
    if(affHealth) affHealth.addEventListener('input', ()=>{ state.A.values.health = affHealth.value; save(false); render(); });
    if(affWealth) affWealth.addEventListener('input', ()=>{ state.A.values.wealth = affWealth.value; save(false); render(); });
    if(affRel)    affRel.addEventListener('input',    ()=>{ state.A.values.relationship = affRel.value; save(false); render(); });
    if(visualizedA) visualizedA.addEventListener('change', ()=>{ state.A.visualized = visualizedA.checked; save(false); });

    // B 입력 바인딩 헬퍼
    function bind(el, key){ el && el.addEventListener('input', ()=>{ state.B[key] = el.value; save(false); render(); }); }
    bind(yearEl,'year'); bind(monthEl,'month'); bind(dayEl,'day'); bind(placeEl,'place'); bind(withEl,'with'); bind(doingEl,'doing');
    bind(seeEl,'see'); bind(hearEl,'hear'); bind(feelEl,'feel');
    if(visualizedB) visualizedB.addEventListener('change', ()=>{ state.B.visualized = visualizedB.checked; save(false); });

    // 초기화
    clearBtn.addEventListener('click', ()=>{
      state = { mode: state.mode, A:{ selected:[], values:{health:'',wealth:'',relationship:''}, visualized:false }, B:{year:'',month:'',day:'',place:'',with:'',doing:'',see:'',hear:'',feel:'',visualized:false} };
      save(true); render();
    });

    // 다음 단계로 전달
    nextBtn.addEventListener('click', ()=>{
      const payload = { mode: state.mode, data: (state.mode==='A' ? state.A : state.B) };
      try{ sessionStorage.setItem('thisdive_affirmation_payload', JSON.stringify(payload)); }catch(e){}
      flashToast('확언이 저장되었어요');
      // TODO: 실제 경로로 이동 (예: goal.html)
      // location.href = 'goal.html';
    });

    // 복원
    (function restore(){
      try{
        const raw = localStorage.getItem(KEY);
        if(raw){
          const data = JSON.parse(raw);
          state = Object.assign({}, state, data||{});
        }
      }catch(e){}
      switchTab(state.mode || 'A');
    })();
  </script>
</body>
</html>
