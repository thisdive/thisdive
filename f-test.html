<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>미래확언 — thisdive</title>
  
  <!-- 현실적인 단일 파일용 CSP (개발 단계). 배포 시 app.js/app.css로 분리하고 'unsafe-inline' 제거 권장 -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data:; 
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline';
    font-src 'self';
    connect-src 'self';
    frame-ancestors 'none';
    base-uri 'self';
    upgrade-insecure-requests
  ">

  <meta name="color-scheme" content="light" />
  <meta name="referrer" content="strict-origin-when-cross-origin">
  
  <style>
    :root{
      /* 지윤 감성 팔레트 */
      --bg:#f7f3ed;           /* 전체 배경 연베이지 */
      --card:#ffffff;         /* 카드 배경 */
      --fg:#2a3249;           /* 본문 글자(네이비 톤) */
      --muted:#6b7280;        /* 서브 텍스트 */
      --rose-100:#f4e6e2;     /* 연한 로즈(하이라이트) */
      --rose-300:#d7a8b5;     /* 중간 로즈(테두리/포커스) */
      --beige-200:#ece6df;    /* 라인/칩 테두리 */
      --beige-300:#e5ddd3;    /* 호버 배경 */
      --ring:#d7a8b5;         /* 포커스 링 */
      --ok:#2a7a4b;           /* 확인/완료 텍스트 */
      --wrap: 980px;          /* 최대 너비 */
      --radius-xl: 22px;      /* 큰 둥근모서리 */
      --radius-md: 14px;      /* 중간 둥근모서리 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family: system-ui, -apple-system, "Pretendard", "Apple SD Gothic Neo", "Malgun Gothic", "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* 헤더 */
    .header{position:sticky; top:0; z-index:10; background:var(--bg); border-bottom:1px solid var(--beige-200)}
    .header .inner{max-width:var(--wrap); margin:0 auto; padding:14px 22px; display:flex; align-items:center; justify-content:center; position:relative}
    .title{font-weight:700; letter-spacing:-0.2px}

    /* 래퍼 & 카드 */
    .wrap{display:grid; place-items:center; padding:22px}
    .card{width:100%; max-width:var(--wrap); background:var(--card); border:1px solid var(--beige-200); border-radius:var(--radius-xl); box-shadow:0 8px 24px rgba(0,0,0,.04); overflow:hidden}
    .card-head{padding:22px 22px 10px; border-bottom:1px solid var(--beige-200)}
    .card-head .subtitle{font-size:14px; color:var(--muted)}
    .card-body{padding:18px 22px 18px}
    .section + .section{margin-top:18px}

    /* 칩 영역 */
    .chips{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}
    .chip{
      --chip-pad: 10px 14px;
      display:inline-flex; align-items:center; gap:8px; cursor:pointer;
      background:#fff; border:1px solid var(--beige-200); color:var(--fg);
      padding:var(--chip-pad); border-radius:999px; font-size:14px;
      transition:transform .06s ease, background-color .2s ease, border-color .2s ease;
    }
    .chip:hover{background:var(--beige-300)}
    .chip:active{transform:translateY(1px)}
    .chip input{appearance:none; width:14px; height:14px; border:1.5px solid var(--beige-200); border-radius:50%; display:inline-block; position:relative}
    .chip[aria-checked="true"] input{border-color:var(--rose-300)}
    .chip[aria-checked="true"] input::after{content:""; position:absolute; inset:3px; background:var(--rose-300); border-radius:50%}

    /* 폼 필드 */
    .fields{display:grid; gap:12px; margin-top:14px}
    .field{display:none}
    .field.show{display:block}
    .label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    .input{
      width:100%; background:#fff; border:1px solid var(--beige-200); border-radius:12px; padding:12px 14px; font-size:15px; color:var(--fg);
      outline:none; transition:border-color .2s ease, box-shadow .2s ease; resize:vertical; min-height:44px
    }
    .input:focus{border-color:var(--rose-300); box-shadow:0 0 0 3px rgba(215,168,181,.22)}
    .template{font-size:13px; color:var(--muted); margin-top:6px}

    /* 시각화 체크 */
    .visualize{display:flex; align-items:center; gap:10px; padding:14px; background:var(--rose-100); border:1px solid var(--beige-200); border-radius:var(--radius-md); margin-top:12px}
    .visualize input{width:16px; height:16px}
    .visualize small{color:var(--muted)}

    /* 푸터 액션 */
    .card-foot{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:16px 22px; border-top:1px solid var(--beige-200); background:#fff}
    .hint{font-size:13px; color:var(--muted)}
    .btn{
      appearance:none; border:1px solid var(--beige-200); background:var(--fg); color:#fff; 
      padding:12px 18px; border-radius:999px; font-weight:600; font-size:15px; cursor:pointer;
      transition:transform .06s ease, background-color .2s ease, border-color .2s ease, opacity .2s ease;
    }
    .btn:hover{opacity:.95}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.45; cursor:not-allowed}
    .btn-secondary{background:#fff; color:var(--fg)}

    /* 토스트 */
    .toast{position:fixed; left:50%; bottom:22px; transform:translateX(-50%); background:#111; color:#fff; padding:12px 16px; border-radius:999px; font-size:14px; box-shadow:0 8px 24px rgba(0,0,0,.18); opacity:0; pointer-events:none; transition:opacity .25s ease}
    .toast.show{opacity:1}

    /* 접근성용 스킵 */
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  </style>
</head>
<body>
  <a class="sr-only" href="#main">본문 바로가기</a>
  <header class="header">
    <div class="inner">
      <div class="title">미래확언(간단형)</div>
    </div>
  </header>

  <main id="main" class="wrap">
    <article class="card" aria-labelledby="h1">
      <div class="card-head">
        <h1 id="h1" style="margin:0 0 6px">나는 지금 ____을 가지고 있다</h1>
        <div class="subtitle">필요한 카테고리를 고르고, 짧게 한 줄로만 적어 보세요.</div>
      </div>

      <div class="card-body">
        <!-- 1) 카테고리 칩 선택 -->
        <section class="section" aria-labelledby="sec-cat">
          <h2 id="sec-cat" class="sr-only">카테고리 선택</h2>
          <div class="chips" role="group" aria-label="카테고리">
            <button class="chip" data-key="health" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>건강</span>
            </button>
            <button class="chip" data-key="wealth" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>부</span>
            </button>
            <button class="chip" data-key="relationship" aria-checked="false" role="checkbox">
              <input aria-hidden="true" />
              <span>관계</span>
            </button>
          </div>
        </section>

        <!-- 2) 선택된 카테고리별 필드 -->
        <section class="section fields" aria-labelledby="sec-fields">
          <h2 id="sec-fields" class="sr-only">확언 입력</h2>

          <div class="field" id="field-health" data-key="health">
            <label class="label" for="aff-health">건강 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-health" class="input" rows="2" placeholder="예) 규칙적인 수면 리듬과 가벼운 몸, 아침의 맑은 집중력"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>

          <div class="field" id="field-wealth" data-key="wealth">
            <label class="label" for="aff-wealth">부 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-wealth" class="input" rows="2" placeholder="예) 한 달 생활이 넉넉해지는 현금흐름과 안정적인 비상금"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>

          <div class="field" id="field-relationship" data-key="relationship">
            <label class="label" for="aff-relationship">관계 — 나는 지금 …을 가지고 있다</label>
            <textarea id="aff-relationship" class="input" rows="2" placeholder="예) 서로의 시간을 존중하는 평온한 대화와 가벼운 웃음"></textarea>
            <div class="template">템플릿: <em>나는 지금 <strong>____</strong>을 가지고 있다.</em></div>
          </div>
        </section>

        <!-- 3) 시각화(셀프 체크) -->
        <section class="section" aria-labelledby="sec-visual">
          <h2 id="sec-visual" class="sr-only">시각화 체크</h2>
          <label class="visualize">
            <input type="checkbox" id="visualized" />
            <div>
              <div><strong>눈을 감고 그 장면을 10초간 떠올려 보았어요</strong></div>
              <small>호흡을 3번 가볍게 하고, 몸의 감각(온도/자세/미세한 표정)까지 느껴보면 좋아요.</small>
            </div>
          </label>
        </section>
      </div>

      <div class="card-foot">
        <div class="hint" id="hint">선택한 카테고리 0개</div>
        <div style="display:flex; gap:10px">
          <button class="btn btn-secondary" id="btn-clear" type="button" title="입력 초기화">초기화</button>
          <button class="btn" id="btn-next" type="button" title="목표설정으로 이동" disabled>다음 → 목표설정</button>
        </div>
      </div>
    </article>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite">저장되었습니다</div>

  <script>
    // 로컬스토리지 키
    const KEY = 'thisdive_affirmation_v1';

    // 요소 참조
    const chips = Array.from(document.querySelectorAll('.chip'));
    const fields = Array.from(document.querySelectorAll('.field'));
    const hintEl = document.getElementById('hint');
    const nextBtn = document.getElementById('btn-next');
    const clearBtn = document.getElementById('btn-clear');
    const toast = document.getElementById('toast');
    const visualized = document.getElementById('visualized');

    // 상태
    let state = {
      selected: [], // ['health','wealth','relationship']
      values: { health:'', wealth:'', relationship:'' },
      visualized: false
    };

    // 유틸: 저장 & 토스트
    function save(showToast=true){
      try{
        localStorage.setItem(KEY, JSON.stringify(state));
        if(showToast) flashToast('저장되었습니다');
      }catch(e){ /* storage 불가 시 조용히 무시 */ }
      render();
    }
    function flashToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 1400);
    }

    // 렌더
    function render(){
      // 칩 aria 상태 및 필드 show/hide
      chips.forEach(chip => {
        const key = chip.dataset.key;
        const on = state.selected.includes(key);
        chip.setAttribute('aria-checked', String(on));
        const field = document.querySelector(`.field[data-key="${key}"]`);
        if(field){ field.classList.toggle('show', on); }
      });

      // 힌트 및 다음 버튼
      hintEl.textContent = `선택한 카테고리 ${state.selected.length}개`;

      const anyText = state.selected.some(k => (state.values[k]||'').trim().length > 0);
      nextBtn.disabled = !(state.selected.length > 0 && anyText);

      // 체크박스
      visualized.checked = !!state.visualized;
    }

    // 칩 토글
    chips.forEach(chip => {
      chip.addEventListener('click', () => {
        const key = chip.dataset.key;
        const i = state.selected.indexOf(key);
        if(i>=0){ state.selected.splice(i,1); }
        else { state.selected.push(key); }
        save(false);
      });
    });

    // 텍스트 입력 핸들러(입력 시 자동 저장)
    fields.forEach(field => {
      const key = field.dataset.key;
      const ta = field.querySelector('textarea');
      ta.addEventListener('input', () => {
        state.values[key] = ta.value;
        save(false);
      });
    });

    // 시각화 체크
    visualized.addEventListener('change', () => {
      state.visualized = visualized.checked;
      save(false);
    });

    // 초기화
    clearBtn.addEventListener('click', () => {
      state = { selected: [], values:{health:'',wealth:'',relationship:''}, visualized:false };
      save();
    });

    // 다음(목표설정으로 이동) — 실제 연결은 프로젝트 구조에 맞게 수정
    nextBtn.addEventListener('click', () => {
      // 페이지 간 전달 예시: sessionStorage
      try{ sessionStorage.setItem('thisdive_affirmation_payload', JSON.stringify(state)); }catch(e){}
      flashToast('확언이 저장되었어요');
      // TODO: 실제 경로로 이동 (예: location.href = 'goal.html')
      // location.href = 'goal.html';
    });

    // 복원
    (function restore(){
      try{
        const raw = localStorage.getItem(KEY);
        if(raw){
          const data = JSON.parse(raw);
          state = Object.assign({ selected:[], values:{health:'',wealth:'',relationship:''}, visualized:false }, data);
          // 값 주입
          Object.entries(state.values).forEach(([k,v])=>{
            const ta = document.querySelector(`.field[data-key="${k}"] textarea`);
            if(ta) ta.value = v || '';
          });
        }
      }catch(e){}
      render();
    })();
  </script>
</body>
</html>
