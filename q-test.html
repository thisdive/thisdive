/* 인덱스 재진입 초기화 대응: 토큰/감정 스냅샷을 보고 자기 UI를 비운다 */
(function enforceResetFromIndex(){
  const NS = 'thisdive';
  const K_RESET = `${NS}.resetEpoch`;
  const K_SEEN  = `${NS}.seenEpoch:p3`;      // 이 페이지가 마지막으로 본 초기화 토큰
  const K_P2    = `${NS}.p2:current`;        // 감정 스냅샷
  const K_QDATA = `${NS}.q:data`;            // (이 페이지의 저장값)

  function uiReset(){
    // 저장값 제거
    try { localStorage.removeItem(K_QDATA); } catch(e){}
    // UI 즉시 초기화
    try {
      const catField = document.getElementById('catField');
      if (catField) {
        catField.querySelectorAll('.chip').forEach(c=>{
          c.classList.remove('on');
          const r=c.querySelector('input[type="radio"]');
          if (r) r.checked=false;
        });
      }
      document.querySelectorAll('input[name="difficulty"]').forEach(r=> r.checked=false);
      const readout=document.getElementById('readout');
      if (readout) readout.textContent='미정';
      const goalEl=document.getElementById('goalInput');
      if (goalEl) goalEl.value='';
    } catch(e){}
  }

  function maybeReset(){
    const resetEpoch = localStorage.getItem(K_RESET) || '';
    const seenEpoch  = sessionStorage.getItem(K_SEEN) || '';
    const hasEmotion = !!localStorage.getItem(K_P2); // 감정이 없으면 새 세션으로 판단

    // ① 인덱스에서 새 토큰이 생겼거나 ② 감정 스냅샷 자체가 없으면 ⇒ 초기화
    if (resetEpoch !== seenEpoch || !hasEmotion) {
      uiReset();
      try { sessionStorage.setItem(K_SEEN, resetEpoch); } catch(e){}
    }
  }

  // 처음 진입 + bfcache 복원 모두 커버
  maybeReset();
  window.addEventListener('pageshow', maybeReset);
})();
