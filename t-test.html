<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>오늘의 몰입</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- ▣ 보안: CSP (출처 최소화 + iframe 금지) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline';
    style-src  'self' 'unsafe-inline' https://fonts.googleapis.com;
    img-src    'self' data:;
    font-src   'self' https://fonts.gstatic.com https://fonts.googleapis.com;
    connect-src 'self';
    frame-ancestors 'none';
    base-uri 'self';
    upgrade-insecure-requests
  ">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <!-- 캐시 방지 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- 폰트 (원 코드 유지) -->
  <link href="https://fonts.googleapis.com/css2?family=MaruBuri:wght@400&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'MaruBuri', sans-serif;
      background-color: #f7f3ee;
      color: #2a3249;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      min-height: 100vh; padding: 60px 16px 24px; margin: 0;
    }
    h1 { margin-bottom: 15px; font-size: 24px; font-weight: bold; }

    /* 🔶 목표 문구만 노란 하이라이트 */
    .goal-banner{ margin: 0 0 28px; text-align:center; max-width:min(86vw, 720px); }
    .goal-banner .hl{
      font-weight:500; font-size:18.5px; padding:0 6px;
      background: linear-gradient(transparent 60%, #FFD8C2 0);
      border-radius:4px;
    }

    .timer-controls { display: flex; gap: 12px; margin-bottom: 42px; flex-wrap: wrap; justify-content: center; }
    .timer-controls button {
      background-color: #F3ECE2; color: #2a3249; border: none;
      padding: 10px 16px; border-radius: 8px; font-size: 16px; cursor: pointer;
      transition: transform .06s ease, box-shadow .12s ease;
    }
    .timer-controls button:active{ transform: translateY(1px); }

    .circle-timer { position: relative; width: 220px; height: 220px; margin-bottom: 20px; }
    .circle-timer svg { transform: rotate(-90deg); }
    .circle-timer circle { fill: none; stroke-width: 6; }
    .bg { stroke: #e8dfd6; }
    .progress { stroke: #2a3249; stroke-linecap: round; transition: stroke-dashoffset 1s linear; }
    .time-text { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center;
      font-size: 32px; font-weight: bold; }

    .reflection { text-align: center; margin-top: 12px; }
    .reflection p { margin: 8px 0 25px; font-size: 16px; }

    /* ‘몰입 완료’ 버튼 */
    .reflection button {
      background-color: #F3ECE2; color: #2a3249; border: none;
      padding: 10px 16px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;
      transition: background-color .15s ease, color .15s ease;
    }
    .reflection button:disabled { opacity: .5; cursor: not-allowed; }

    /* ✅ 완료 상태 */
    .reflection button.done {
      background-color: #2A3249;
      color: #F3ECE2;
      pointer-events: none;
    }

    /* 선택 시간 하이라이트 */
    .timer-controls button.active {
      background-color: #2a3249;
      color: #F3ECE2; font-weight: 550;
    }

    /* 토스트 */
    .toast{
      position: fixed; left: 50%; bottom: 75px; transform: translateX(-50%) translateY(12px);
      padding: 12px 16px; background:#fff; color:#2A3249; border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18); opacity: 0; transition: opacity .2s ease, transform .2s ease;
      z-index: 10000; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; white-space: nowrap;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 420px){
      .goal-banner .hl{ font-size:17px; }
    }

    .back-btn{
      appearance:none; border:1px solid #e5e7eb; background:#fff; color:#374151;
      width:36px; height:36px; border-radius:10px; font-size:18px; line-height:1;
      display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
      margin:0 8px 8px 0; align-self:flex-start;
    }
    .back-btn:active{ transform: translateY(1px); }
  </style>
</head>
<body>

<!-- ▼▼ timer.html: BACK BUTTON -->
<button id="backBtn" class="back-btn" type="button" aria-label="뒤로가기">←</button>

  <h1>오늘의 몰입</h1>

  <!-- 🎯 목표 문구(하이라이트만) -->
  <div id="goalBanner" class="goal-banner" hidden>
    <span id="goalText" class="hl"></span>
  </div>

  <div class="timer-controls" id="timeButtons">
    <button>1분</button>
    <button>15분</button>
    <button>30분</button>
    <button>45분</button>
    <button>60분</button>
  </div>

  <div class="circle-timer">
    <svg width="220" height="220" aria-hidden="true">
      <circle class="bg" cx="110" cy="110" r="100"></circle>
      <circle class="progress" cx="110" cy="110" r="100" stroke-dasharray="628.3" stroke-dashoffset="0"></circle>
    </svg>
    <div class="time-text" id="time">00:00</div>
  </div>

  <div class="reflection">
    <p>👇 몰입 종료 후 눌러주세요.</p>
    <button id="completeBtn" disabled>✔️ 몰입 완료</button>
  </div>

  <!-- 토스트 -->
  <div id="toast" class="toast" hidden aria-live="polite">수고했어요! 오늘도 몰입 완료 😻</div>

  <script>
    /* =========================
       네임스페이스 & 키 (page4)
       ========================= */
    const NS = 'thisdive';
    const K_G_DATA   = `${NS}.g:data`;
    const K_P4_LAST  = `${NS}.p4:lastSource`;
    const K_T_DATA   = `${NS}.t:data`;
    const K_T_MUSTRESET = `${NS}.t:mustReset`;

    (function resetIfHash(){
      if (location.hash.replace('#','') === 'reset') {
        try{
          sessionStorage.clear();
          localStorage.removeItem(K_G_DATA);
          localStorage.removeItem(K_P4_LAST);
          localStorage.removeItem(K_T_DATA);
          sessionStorage.removeItem(K_T_MUSTRESET);
        }catch(e){}
      }
    })();

    let timerInterval = null;
    let totalSeconds = 0;
    let remainingSeconds = 0;

    const timeEl = document.getElementById('time');
    const progressEl = document.querySelector('.progress');
    const timeButtonsWrap = document.getElementById('timeButtons');
    const completeBtn = document.getElementById('completeBtn');

    function resetVisual(){
      clearInterval(timerInterval);
      timerInterval = null;
      totalSeconds = 0;
      remainingSeconds = 0;
      timeEl.textContent = '00:00';
      const radius = 100, circumference = 2 * Math.PI * radius;
      progressEl.style.strokeDasharray = `${circumference}`;
      progressEl.style.strokeDashoffset = `${0}`;
      completeBtn.disabled = true;
      completeBtn.classList.remove('done');
      completeBtn.textContent = '✔️ 몰입 완료';
      document.querySelectorAll('.timer-controls button').forEach(b=> b.classList.remove('active'));
    }

    function snapshotGet(){
      try{
        const raw = localStorage.getItem(K_T_DATA);
        return raw ? JSON.parse(raw) : {};
      }catch(e){ return {}; }
    }
    function snapshotSave(part){
      try{
        const cur = snapshotGet();
        const next = { ...cur, ...part };
        localStorage.setItem(K_T_DATA, JSON.stringify(next));
      }catch(e){}
    }

    function updateTimeDisplay() {
      const min = String(Math.floor((remainingSeconds||0) / 60)).padStart(2, '0');
      const sec = String((remainingSeconds||0) % 60).padStart(2, '0');
      timeEl.textContent = `${min}:${sec}`;
    }
    function updateProgressCircle() {
      const radius = 100;
      const circumference = 2 * Math.PI * radius;
      const ratio = totalSeconds ? (1 - (remainingSeconds / totalSeconds)) : 0;
      progressEl.style.strokeDasharray = `${circumference}`;
      progressEl.style.strokeDashoffset = `${circumference * ratio}`;
    }

    function startTimer(minutes) {
      clearInterval(timerInterval);
      totalSeconds = minutes * 60;
      remainingSeconds = totalSeconds;
      updateTimeDisplay();
      updateProgressCircle();
      completeBtn.disabled = true;

      snapshotSave({ minutes, startedAt: Date.now(), finished:false });

      timerInterval = setInterval(() => {
        remainingSeconds--;
        updateTimeDisplay();
        updateProgressCircle();
        if (remainingSeconds % 5 === 0) snapshotSave({ tick: Date.now() });
        if (remainingSeconds <= 0) {
          clearInterval(timerInterval);
          remainingSeconds = 0;
          completeBtn.disabled = false;
          snapshotSave({ finished:true, finishedAt: Date.now() });
        }
      }, 1000);
    }

    function restoreTimer(){
      const s = snapshotGet();
      if (s && s.minutes){
        const btn = [...document.querySelectorAll('.timer-controls button')]
          .find(b => parseInt(b.textContent,10) === Number(s.minutes));
        if (btn) btn.classList.add('active');
      }
      if (s && s.minutes && s.startedAt && !s.finished){
        const elapsed = Math.max(0, Math.floor((Date.now() - s.startedAt)/1000));
        totalSeconds = Number(s.minutes) * 60;
        remainingSeconds = Math.max(0, totalSeconds - elapsed);
        if (remainingSeconds > 0){
          clearInterval(timerInterval);
          timerInterval = setInterval(()=>{
            remainingSeconds--;
            updateTimeDisplay();
            updateProgressCircle();
            if (remainingSeconds <= 0){
              clearInterval(timerInterval);
              completeBtn.disabled = false;
              snapshotSave({ finished:true, finishedAt: Date.now() });
            }
          }, 1000);
        }else{
          remainingSeconds = 0;
          completeBtn.disabled = false;
        }
        updateTimeDisplay();
        updateProgressCircle();
        return;
      }
      if (s && s.finished){
        totalSeconds = Number(s.minutes || 0) * 60;
        remainingSeconds = 0;
        updateTimeDisplay();
        updateProgressCircle();
        completeBtn.disabled = false;
      }
    }

    /* ============ 초기 진입 시 준비 ============ */
    (function checkSourceAndInit(){
      const sp = new URLSearchParams(location.search);
      let goal = (sp.get('goal') || '').trim();
      if(!goal){ try{ goal = sessionStorage.getItem(`${NS}.goal`) || ''; }catch(e){} }
      if(goal){
        document.getElementById('goalText').textContent = goal;
        document.getElementById('goalBanner').hidden = false;
      }

      // goal.html 다녀온 뒤 복귀 시 강제 초기화 플래그
      let mustReset = false;
      try{
        if (sessionStorage.getItem(K_T_MUSTRESET) === '1') {
          mustReset = true;
          sessionStorage.removeItem(K_T_MUSTRESET);
        }
      }catch(e){}

      let gRaw=null, p4Raw=null;
      try{
        gRaw  = localStorage.getItem(K_G_DATA);
        p4Raw = localStorage.getItem(K_P4_LAST);
      }catch(e){}

      if (mustReset || gRaw !== p4Raw) {
        try{ localStorage.removeItem(K_T_DATA); }catch(e){}
        try{ localStorage.setItem(K_P4_LAST, gRaw ?? ''); }catch(e){}
        resetVisual();
      } else {
        restoreTimer();
      }

      updateTimeDisplay();
      updateProgressCircle();
    })();

    /* ============ 시간 버튼 ============ */
    const timeButtonsWrap = document.getElementById('timeButtons');
    timeButtonsWrap.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      document.querySelectorAll('.timer-controls button').forEach(b=> b.classList.remove('active'));
      btn.classList.add('active');
      const n = parseInt(btn.textContent, 10);
      if(Number.isFinite(n) && n > 0){
        startTimer(n);
        snapshotSave({ minutes:n });
      }
    });

    /* ============ 완료 버튼 ============ */
    (function(){
      const cbtn = document.getElementById('completeBtn');
      if(!cbtn) return;
      cbtn.addEventListener('click', (e)=>{
        e.preventDefault();
        cbtn.classList.add('done');
        cbtn.textContent = '💫몰입 성공💫';

        const toast = document.getElementById('toast');
        if(toast){
          toast.hidden = false;
          requestAnimationFrame(()=> toast.classList.add('show'));
          setTimeout(()=>{
            toast.classList.remove('show');
            setTimeout(()=> toast.hidden = true, 200);
          }, 3000);
        }
      }, { once:true });
    })();

    /* ============ 뒤로가기: goal.html로 이동 + 복귀 시 초기화 플래그 설정 ============ */
    (function(){
      const btn = document.getElementById('backBtn');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        try{ sessionStorage.setItem(K_T_MUSTRESET, '1'); }catch(e){}
        // 필요하면 추가로 현재 진행 상태도 지움
        try{
          localStorage.removeItem(K_T_DATA);
        }catch(e){}
        // goal.html로 이동
        location.href = 'goal.html?v=' + Date.now();
      });
    })();

    /* ============ BFCache로 돌아왔을 때도 항상 초기화 ============ */
    window.addEventListener('pageshow', (e)=>{
      const nav = (performance.getEntriesByType && performance.getEntriesByType('navigation') || [])[0];
      const isBF = e.persisted || (nav && nav.type === 'back_forward');
      if (isBF) {
        try{
          localStorage.removeItem(K_T_DATA);
          sessionStorage.removeItem(K_T_MUSTRESET);
        }catch(e){}
        resetVisual();
      }
    });
  </script>
</body>
</html>
